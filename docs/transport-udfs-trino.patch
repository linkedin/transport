From 3e94c6d2a66784df9137f0a028b8a6525f7ee110 Mon Sep 17 00:00:00 2001
From: Jing-Wei <jinlu@linkedin.com>
Date: Sat, 25 Mar 2023 14:38:18 -0700
Subject: [PATCH] TRINO-4650 Update PluginManager to load transport udf

---
 .../java/io/trino/server/PluginManager.java   | 39 ++++++++++++++++++-
 1 file changed, 38 insertions(+), 1 deletion(-)

diff --git a/core/trino-main/src/main/java/io/trino/server/PluginManager.java b/core/trino-main/src/main/java/io/trino/server/PluginManager.java
index 6f8132cc47..8acc015a77 100644
--- a/core/trino-main/src/main/java/io/trino/server/PluginManager.java
+++ b/core/trino-main/src/main/java/io/trino/server/PluginManager.java
@@ -24,6 +24,7 @@ import io.trino.metadata.GlobalFunctionCatalog;
 import io.trino.metadata.HandleResolver;
 import io.trino.metadata.InternalFunctionBundle;
 import io.trino.metadata.InternalFunctionBundle.InternalFunctionBundleBuilder;
+import io.trino.metadata.SqlScalarFunction;
 import io.trino.metadata.TypeRegistry;
 import io.trino.security.AccessControlManager;
 import io.trino.security.GroupProviderManager;
@@ -58,6 +59,7 @@ import java.util.Set;
 import java.util.concurrent.atomic.AtomicBoolean;
 import java.util.function.Function;
 import java.util.function.Supplier;
+import java.util.stream.Collectors;
 
 import static com.google.common.base.Preconditions.checkState;
 import static java.util.Arrays.asList;
@@ -66,8 +68,27 @@ import static java.util.Objects.requireNonNull;
 @ThreadSafe
 public class PluginManager
 {
+    // As part of enabling SqlScalarFunctions to be loaded as Plugins, we introduce two changes to this
+    // class: 1) adding more packages to the SPI_PACKAGES list so that SqlScalarFunction class and its
+    // dependencies are visible to the PluginClassLoader (which is responsible of resolving Plugin dependencies)
+    // 2) registering SqlScalarFunction classes found in the plugin directory jars (or expressed as pom files)
+    // as it is the case with vanilla plugins.
+    // JIRA: https://jira01.corp.linkedin.com:8443/browse/LIHADOOP-34269
     private static final ImmutableList<String> SPI_PACKAGES = ImmutableList.<String>builder()
+            // io.trino.metadata is required for SqlScalarFunction, Metadata, MetadataManager, FunctionBinding,
+            // FunctionDependencies, TypeVariableConstraint, FunctionArgumentDefinition, FunctionKind, FunctionMetadata,
+            // Signature and SignatureBinder classes
+            .add("io.trino.metadata.")
+            // io.trino.operator. is required for AbstractTestFunctions, ScalarFunctionImplementation
+            // & ChoicesScalarFunctionImplementation
+            .add("io.trino.operator.")
+            // io.trino.sql.analyzer.TypeSignatureTranslator. is required for parseTypeSignature
+            .add("io.trino.sql.analyzer.TypeSignatureTranslator.")
             .add("io.trino.spi.")
+            // io.trino.type is required for UnknownType
+            .add("io.trino.type.")
+            // io.trino.util is required for Reflection
+            .add("io.trino.util.")
             .add("com.fasterxml.jackson.annotation.")
             .add("io.airlift.slice.")
             .add("org.openjdk.jol.")
@@ -161,12 +182,28 @@ public class PluginManager
     {
         ServiceLoader<Plugin> serviceLoader = ServiceLoader.load(Plugin.class, pluginClassLoader);
         List<Plugin> plugins = ImmutableList.copyOf(serviceLoader);
-        checkState(!plugins.isEmpty(), "No service providers of type %s in the classpath: %s", Plugin.class.getName(), asList(pluginClassLoader.getURLs()));
+
+        ServiceLoader<SqlScalarFunction> sqlScalarFunctionsServiceLoader = ServiceLoader.load(SqlScalarFunction.class, pluginClassLoader);
+        List<SqlScalarFunction> sqlScalarFunctions = ImmutableList.copyOf(sqlScalarFunctionsServiceLoader);
+
+        checkState(!plugins.isEmpty() || !sqlScalarFunctions.isEmpty(),
+                "No service providers of type %s or %s in the classpath: %s", Plugin.class.getName(), SqlScalarFunction.class.getName(), asList(pluginClassLoader.getURLs()));
 
         for (Plugin plugin : plugins) {
             log.info("Installing %s", plugin.getClass().getName());
             installPlugin(plugin, pluginClassLoader::duplicate);
         }
+
+        InternalFunctionBundleBuilder builder = InternalFunctionBundle.builder();
+        for (SqlScalarFunction sqlScalarFunction : sqlScalarFunctions) {
+            log.info("Registering function %s(%s)",
+                    sqlScalarFunction.getFunctionMetadata().getSignature().getName(),
+                    sqlScalarFunction.getFunctionMetadata().getSignature().getArgumentTypes().stream()
+                            .map(e -> e.toString())
+                            .collect(Collectors.joining(", ")));
+            builder.function(sqlScalarFunction);
+        }
+        globalFunctionCatalog.addFunctions(builder.build());
     }
 
     public void installPlugin(Plugin plugin, Function<CatalogHandle, ClassLoader> duplicatePluginClassLoaderFactory)
-- 
2.37.1 (Apple Git-137.1)

